{% if (cycloid_nginx_secure_header_enabled | default(false)) | bool %}
# top-level (http)
limit_req_zone $binary_remote_addr zone=rl_reset_ip:10m rate=20r/m;
{% endif %}

server {
    listen       443 ssl;
    server_name  "{{ cycloid_api_dns }}";
    client_max_body_size 20M;

    {% if cycloid_nginx_ssl_protocols is defined and cycloid_nginx_ssl_protocols|length %}
    ssl_protocols {{ cycloid_nginx_ssl_protocols }};
    {% endif %}

    #access_log /var/log/nginx/cycloid-api-access.log;
    #error_log  /var/log/nginx/cycloid-api-error.log;

    ssl_certificate     /etc/nginx/ssl/ssl.crt;
    ssl_certificate_key /etc/nginx/ssl/ssl.key;

    location / {
      proxy_pass                {{ cycloid_nginx_api_proxy_pass }};
      proxy_set_header          X-FORWARDED_PROTO https;
      proxy_set_header          X-FORWARDED_PORT 443;
      proxy_connect_timeout     360s;
      proxy_send_timeout        360s;
      proxy_read_timeout        360s;
    }

    {% if (cycloid_nginx_secure_header_enabled | default(false)) | bool %}
    location = /user/reset_password {
      # apply IP rate limit
      limit_req zone=rl_reset_ip burst=40 nodelay;

      proxy_pass                {{ cycloid_nginx_api_proxy_pass }};
      proxy_set_header          X-FORWARDED_PROTO https;
      proxy_set_header          X-FORWARDED_PORT 443;
      proxy_connect_timeout     360s;
      proxy_send_timeout        360s;
      proxy_read_timeout        360s;
    }
    {% endif %}
}