{
  "pipeline_name": "start-stop-$PROJECT-$ENV",
  "passed_config": "{\"groups\":[{\"name\":\"status\",\"jobs\":[\"rds\",\"ec2\",\"asg\"]},{\"name\":\"manual\",\"jobs\":[\"start\",\"stop\"]},{\"name\":\"scheduled\",\"jobs\":[\"cron-stop\"]},{\"name\":\"Overview all\",\"jobs\":[\"cron-stop\",\"start\",\"stop\",\"rds\",\"ec2\",\"asg\"]}],\"resource_types\":[{\"name\":\"cron-resource\",\"type\":\"docker-image\",\"source\":{\"repository\":\"cftoolsmiths\/cron-resource\"}},{\"name\":\"keyval\",\"type\":\"docker-image\",\"source\":{\"repository\":\"swce\/keyval-resource\"}}],\"resources\":[{\"name\":\"stop\",\"type\":\"cron-resource\",\"source\":{\"expression\":\"00 19 * * *\",\"location\":\"Europe\/Paris\",\"fire_immediately\":false}},{\"name\":\"trigger\",\"type\":\"keyval\"}],\"jobs\":[{\"name\":\"start\",\"build_logs_to_retain\":3,\"plan\":[{\"do\":[{\"task\":\"start\",\"config\":{\"platform\":\"linux\",\"image_resource\":{\"type\":\"docker-image\",\"source\":{\"repository\":\"busybox\",\"tag\":\"latest\"}},\"run\":{\"path\":\"\/bin\/sh\",\"args\":[\"-ec\",\"echo \\\"action=start\\\" > output\/keyval.properties\\n\"]},\"outputs\":[{\"name\":\"output\"}]}},{\"put\":\"trigger\",\"params\":{\"file\":\"output\/keyval.properties\"}}]}]},{\"name\":\"stop\",\"build_logs_to_retain\":3,\"plan\":[{\"do\":[{\"task\":\"stop\",\"config\":{\"platform\":\"linux\",\"image_resource\":{\"type\":\"docker-image\",\"source\":{\"repository\":\"busybox\",\"tag\":\"latest\"}},\"run\":{\"path\":\"\/bin\/sh\",\"args\":[\"-ec\",\"echo \\\"action=stop\\\" > output\/keyval.properties\\n\"]},\"outputs\":[{\"name\":\"output\"}]}},{\"put\":\"trigger\",\"params\":{\"file\":\"output\/keyval.properties\"}}]}]},{\"name\":\"cron-stop\",\"build_logs_to_retain\":3,\"plan\":[{\"do\":[{\"get\":\"stop\",\"trigger\":true},{\"task\":\"stop\",\"config\":{\"platform\":\"linux\",\"image_resource\":{\"type\":\"docker-image\",\"source\":{\"repository\":\"busybox\",\"tag\":\"latest\"}},\"run\":{\"path\":\"\/bin\/sh\",\"args\":[\"-ec\",\"echo \\\"action=stop\\\" > output\/keyval.properties\\n\"]},\"outputs\":[{\"name\":\"output\"}]}},{\"put\":\"trigger\",\"params\":{\"file\":\"output\/keyval.properties\"}}]}]},{\"name\":\"rds\",\"build_logs_to_retain\":3,\"plan\":[{\"do\":[{\"get\":\"trigger\",\"trigger\":true},{\"task\":\"trigger\",\"config\":{\"platform\":\"linux\",\"image_resource\":{\"type\":\"docker-image\",\"source\":{\"repository\":\"cycloid\/cycloid-toolkit\",\"tag\":\"latest\"}},\"run\":{\"path\":\"\/bin\/sh\",\"args\":[\"-ec\",\"while IFS= read -r var; do if [ ! -z \\\"$var\\\" ]; then echo \\\"Adding: $var\\\"; export \\\"$var\\\"; fi; done < trigger\/keyval.properties\\n# Construct command filters from tags\\nif [ \\\"$action\\\" = \\\"start\\\" ]; then\\n    LookingFor=\\\"stopped\\\"\\nelse\\n    LookingFor=\\\"available\\\"\\nfi\\nfilters=\\\"\\\"\\nfor tag in $TAGS; do\\n  key=${tag%=*}\\n  value=${tag#*=}\\n  if [ -z \\\"$filters\\\" ]; then\\n    filters='contains(TagList[?Key==`'$key'`].Value, `'$value'`)'\\n    continue\\n  fi\\n  filters=$filters' && contains(TagList[?Key==`'$key'`].Value, `'$value'`)'\\ndone\\necho \\\"trigger $action on :\\\"\\n# status available or stopped\\nfor rds in $(aws rds describe-db-instances --query 'DBInstances[?MultiAZ==`false` && DBInstanceStatus==`'${LookingFor}'`].DBInstanceArn' --output text); do\\n  matched=$(aws rds list-tags-for-resource --resource-name $rds --query \\\"$filters\\\")\\n  if [ \\\"$matched\\\" = 'true' ]; then\\n    # fetch only the user-identified name and not the full ARN\\n    id=$(echo \\\"$rds\\\" | awk -F \\\":\\\" '{print $NF}')\\n    aws rds ${action}-db-instance --db-instance-identifier \\\"$id\\\"\\n  fi\\ndone\\n\"]},\"inputs\":[{\"name\":\"trigger\"}]},\"params\":{\"TAGS\":\"env=$ENV client=$ORGANIZATION project=$PROJECT cycloid.io=\\\"true\\\"\",\"AWS_DEFAULT_REGION\":\"$AWS_DEFAULT_REGION\",\"AWS_SECRET_ACCESS_KEY\":\"$AWS_SECRET_ACCESS_KEY\",\"AWS_ACCESS_KEY_ID\":\"$AWS_ACCESS_KEY_ID\"}}]}]},{\"name\":\"asg\",\"build_logs_to_retain\":3,\"plan\":[{\"do\":[{\"get\":\"trigger\",\"trigger\":true},{\"task\":\"trigger\",\"config\":{\"platform\":\"linux\",\"image_resource\":{\"type\":\"docker-image\",\"source\":{\"repository\":\"cycloid\/cycloid-toolkit\",\"tag\":\"latest\"}},\"run\":{\"path\":\"\/bin\/bash\",\"args\":[\"-ec\",\"while IFS= read -r var; do if [ ! -z \\\"$var\\\" ]; then echo \\\"Adding: $var\\\"; export \\\"$var\\\"; fi; done < trigger\/keyval.properties\\n# Construct command filters from tags\\nif [ \\\"$action\\\" = \\\"start\\\" ]; then\\n    filters='DesiredCapacity==`0` && MinSize==`0` && MaxSize==`0`'\\nelse\\n    filters='MaxSize!=`0`'\\nfi\\nfor tag in $TAGS; do\\n  key=${tag%=*}\\n  value=${tag#*=}\\n  filters=$filters' && contains(Tags[?Key==`'$key'`].Value, `'$value'`)'\\ndone\\necho \\\"trigger $action\\\"\\nwhile read asg min max desired; do\\n  if [ -z \\\"$asg\\\" ]; then continue; fi\\n  if [ \\\"$action\\\" = \\\"start\\\" ]; then\\n    if [ \\\"$min\\\" = 'None' ]; then min=1; fi\\n    if [ \\\"$desired\\\" = 'None' ]; then desired=1; fi\\n    if [ \\\"$max\\\" = 'None' ]; then max=2; fi\\n    aws autoscaling update-auto-scaling-group --auto-scaling-group-name $asg --min-size $min --max-size $max --desired-capacity $desired\\n  else\\n    aws autoscaling update-auto-scaling-group --auto-scaling-group-name $asg --min-size 0 --max-size 0 --desired-capacity 0\\n  fi\\ndone < <(aws autoscaling describe-auto-scaling-groups  --query 'AutoScalingGroups[?'\\\"${filters}\\\"'].[AutoScalingGroupName,Tags[?Key==`MinSize`] | [0].Value,Tags[?Key==`MaxSize`] | [0].Value,Tags[?Key==`DesiredCapacity`] | [0].Value]' --output text)\\n\"]},\"inputs\":[{\"name\":\"trigger\"}]},\"params\":{\"TAGS\":\"env=$ENV client=$ORGANIZATION project=$PROJECT cycloid.io=\\\"true\\\"\",\"AWS_DEFAULT_REGION\":\"$AWS_DEFAULT_REGION\",\"AWS_SECRET_ACCESS_KEY\":\"$AWS_SECRET_ACCESS_KEY\",\"AWS_ACCESS_KEY_ID\":\"$AWS_ACCESS_KEY_ID\"}}]}]},{\"name\":\"ec2\",\"build_logs_to_retain\":3,\"plan\":[{\"do\":[{\"get\":\"trigger\",\"passed\":[\"asg\"],\"trigger\":true},{\"task\":\"trigger\",\"config\":{\"platform\":\"linux\",\"image_resource\":{\"type\":\"docker-image\",\"source\":{\"repository\":\"cycloid\/cycloid-toolkit\",\"tag\":\"latest\"}},\"run\":{\"path\":\"\/bin\/sh\",\"args\":[\"-ec\",\"while IFS= read -r var; do if [ ! -z \\\"$var\\\" ]; then echo \\\"Adding: $var\\\"; export \\\"$var\\\"; fi; done < trigger\/keyval.properties\\n# Construct command filters from tags\\nif [ \\\"$action\\\" = \\\"start\\\" ]; then\\n    filters=\\\"Name=instance-state-name,Values=stopped\\\"\\nelse\\n    filters=\\\"Name=instance-state-name,Values=running\\\"\\nfi\\nfor tag in $TAGS; do\\n  key=${tag%=*}\\n  value=${tag#*=}\\n  filters=\\\"$filters Name=tag:$key,Values=$value\\\"\\ndone\\necho \\\"trigger $action\\\"\\ninstances=\\\"\\\"\\nfor instance in $(aws ec2 describe-instances --filters  $filters --query 'Reservations[].Instances[].InstanceId' --output text); do\\n  instances=\\\"${instances} ${instance}\\\"\\ndone\\nif [ -n \\\"$instances\\\" ]; then\\n  aws ec2 ${action}-instances --instance-ids $instances\\nfi\\n\"]},\"inputs\":[{\"name\":\"trigger\"}]},\"params\":{\"TAGS\":\"env=$ENV client=$ORGANIZATION project=$PROJECT cycloid.io=\\\"true\\\"\",\"AWS_DEFAULT_REGION\":\"$AWS_DEFAULT_REGION\",\"AWS_SECRET_ACCESS_KEY\":\"$AWS_SECRET_ACCESS_KEY\",\"AWS_ACCESS_KEY_ID\":\"$AWS_ACCESS_KEY_ID\"}}]}]}]}",
  "environment": {
    "canonical": "$ENV"
  }
}
