---
- name: Setup cycloid
  hosts: all:!concourse_worker
  # centos root user don't have usr/local/bin in PATH. It need to be defined for pip+awscli
  environment:
    PATH: "/usr/local/bin:{{ ansible_env.PATH }}"
  vars_files:
    - [ "environments/cycloid.yml", "environments/{{ env }}-cycloid.yml", "environments/empty.yml" ]
  pre_tasks:
    - name: Update apt packages
      apt:
        update_cache: yes
      when: ansible_os_family == 'Debian'
      ignore_errors: yes

    - name: Update yum packages
      yum:
        update_cache: yes
      when: ansible_os_family == 'RedHat'
      ignore_errors: yes

    # Iptables is used by docker (not present on centos/redhat by default)
    - name: Install extra packages | RedHat
      package:
        name:
          - iptables
        state: present
      when: ansible_os_family == 'RedHat'

  roles:
    - role: geerlingguy.docker
      tags: docker
      when: not validate_only and not uninstall

    - role: ansible-cycloid-onprem
      tags:
        - cycloid

#    - {role: cycloid.prometheus, path: /opt/prometheus, tags: prometheus}
#    - {role: cycloid.telegraf, tags: telegraf}
