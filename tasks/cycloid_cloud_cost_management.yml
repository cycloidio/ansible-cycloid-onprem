---

# Temporary
- name: Create vault_role_id var | cycloid-cloud-cost-management
  shell: cat {{ cycloid_install_path }}/approle-cycloid | grep VAULT_ROLE_ID | awk -F "=" '{print $2}'
  register: vault_role_id

- name: Create vault_secret_id var | cycloid-cloud-cost-management
  shell: cat {{ cycloid_install_path }}/approle-cycloid | grep VAULT_SECRET_ID | awk -F "=" '{print $2}'
  register: vault_secret_id

- name: Define service | cycloid-cloud-cost-management
  include_role:
    name: mhutter.docker-systemd-service
  vars:
    name: cycloid-ccm
    container_docker_pull: "{{ docker_pull }}"
    container_image: "{{cycloid_api_image}}"
    container_ports:
      - '3001'
    container_cmd: "/go/youdeploy-http-api ingest-cost-explorer --config-file=/opt/config.yml --cost-explorer-skip-queue=true"
    container_env:
      VAULT_ROLE_ID: "{{ vault_role_id.stdout }}"
      VAULT_SECRET_ID: "{{ vault_secret_id.stdout }}"
      MYSQL_DATABASE: "{{ cycloid_db_name }}"
      MYSQL_USER: "{{ cycloid_db_user }}"
      MYSQL_PASSWORD: "{{ cycloid_db_password }}"
      YOUDEPLOY_MYSQL_SERVICE_HOST: "{{ cycloid_db_host }}"
      YOUDEPLOY_MYSQL_SERVICE_PORT: "{{ cycloid_db_port }}"
      REDIS_HOST: "{{ cycloid_email_redis_host }}"
      REDIS_PORT: "{{ cycloid_email_redis_port }}"
      REDIS_DB: "{{ cycloid_email_redis_db }}"
      REDIS_URI: "redis://{{ cycloid_email_redis_host }}:{{ cycloid_email_redis_port }}/{{ cycloid_email_redis_db }}"
      VAULT_SKIP_VERIFY: true
      VAULT_URL: "{{ vault_url }}"
      COST_EXPLORER_ES_URL: "{{ cost_explorer_es_url }}"
      COST_EXPLORER_ES_USERNAME: "{{ cost_explorer_es_username }}"
      COST_EXPLORER_ES_PASSWORD: "{{ cost_explorer_es_password }}"
      COST_EXPLORER_ES_INSECURE_SKIP_TLS: "{{ cost_explorer_es_insecure_skip_tls }}"
      LOG_LEVEL: "INFO"
      LOG_SVC_LEVEL: "NONE"
      RUN_MIGRATIONS: 0
    service_systemd_options: [ {'key':'Restart','value':'no'}, {'key':'ExecStop','value':''}]
    service_state: stopped # start or not the service after its creation

  tags: docker-services

- name: Define timer | cycloid-cloud-cost-management
  template:
    src: templates/cloud-cost-management/ccm.timer.j2
    dest: /lib/systemd/system/cycloid-ccm_container.timer
  vars:
    schedule: "*-*-* 00:00:00"

- name: Enable timer | cycloid-cloud-cost-management
  ansible.builtin.systemd:
    name: cycloid-ccm_container.timer
    enabled: yes
    state: started # start or not the timer after its creation

- name: Force systemd to reread configs
  ansible.builtin.systemd:
    daemon_reload: yes