---

validate: True
validate_only: False

# Set to true to uninstall cycloid
uninstall: False

setup_cycloid_core: "{{ 'cycloid_core' in group_names }}"
setup_cycloid_scheduler: "{{ 'cycloid_scheduler' in group_names }}"
setup_cycloid_db: "{{ 'cycloid_db' in group_names }}"
setup_cycloid_cache: "{{ 'cycloid_cache' in group_names }}"
setup_cycloid_scheduler_db: "{{ 'cycloid_scheduler_db' in group_names }}"
setup_cycloid_creds: "{{ 'cycloid_creds' in group_names }}"
#. setup_minio(optional): bool
#+ install and configure minio, a s3-like remote storage
setup_minio: "{{ 'minio' in group_names }}"
#. setup_elasticsearch(optional): bool
#+ install and configure elasticsearch to use it as cycloid external baclend
setup_elasticsearch: "{{ 'elasticsearch' in group_names }}"
# If you let cycloid-smtp:1025, it will start a mailhog smtpd server to satisfy Cycloid requirements
setup_smtp_server: "{{ 'smtp_server' in group_names }}"


cycloid_install_path: /opt/cycloid
cycloid_local_datas_path: "{{ playbook_dir }}/datas"

#
# Pre setup
#

# Install packages regarding OS (debian by default)
cycloid_packages:
  debian:
        - python3-pip
        - default-mysql-client
        - python-setuptools
        - gnupg2
        - pass
        - netcat
  debian-10:
        - python3-pip
        - default-mysql-client
        - python-setuptools
        - gnupg2
        - pass
        - netcat
        - python-backports.ssl-match-hostname
  redhat:
        - python3-pip
        - mysql
        - gnupg2
        - nmap-ncat
  centos-7:
        - python3-pip
        - mysql
        - gnupg2
        - nmap-ncat

cycloid_packages_list: "{{ cycloid_packages[ansible_distribution | lower + '-' + ansible_distribution_major_version] | default(cycloid_packages[ansible_os_family | lower]) }}"

#
# Install your own rootCa on onprem servers
#

# where rootCA stored on serveurs depending of ansible_os_family
ca_certificates_path:
  debian: /usr/local/share/ca-certificates
  redhat: /etc/pki/ca-trust/source/anchors

# To containing your own root certificates to deploy on servers
ca_certificates_local_path: "{{ cycloid_local_datas_path }}/rootca/*"

# System command to update root certificates
ca_certificates_handler:
  debian: "/usr/sbin/update-ca-certificates"
  redhat: "/usr/bin/update-ca-trust"

# Share your rootCA from the host to containers
ca_certificates_container_shared: false

# Certificates volumes to share on containers depending of ansible_os_family
container_volumes_ca_certificates_default:
  debian: "/usr/local/share/ca-certificates:/usr/local/share/ca-certificates"
  redhat: "/etc/pki/ca-trust/source/anchors:/usr/local/share/ca-certificates/anchors"

# If ca_certificates_container_shared, share CA volumes with containers
container_volumes_ca_certificates: "{% if ca_certificates_container_shared %}{{ container_volumes_ca_certificates_default[ansible_os_family | lower] }}{% endif %}"
# If ca_certificates_container_shared, update-ca-certificates on containers
#update_ca_start_post: "{% if ca_certificates_container_shared %}/usr/sbin/update-ca-certificates{% endif %}"
container_args_update_ca: "{% if ca_certificates_container_shared %}--entrypoint /bin/bash{% endif %}"

# container_args_extra can be used to give extra argument when running all containers.
# It can be used for example to override domain server "--dns 172.17.0.1"
container_args_extra: ""

# If ca_certificates_container_shared, run update-ca before the /entrypoint
cycloid_api_container_cmd: "{% if ca_certificates_container_shared %}-c \"/usr/sbin/update-ca-certificates; /entrypoint\"{% endif %}"

# Cloud Cost Management cmd
cycloid_job_ccm_ingestion_container_args: "/go/youdeploy-http-api ingest-cost-explorer --config-file=/opt/config.yml --cost-explorer-skip-queue=true"
cycloid_job_ccm_ingestion_container_cmd: "{% if ca_certificates_container_shared %}-c \"/usr/sbin/update-ca-certificates; /entrypoint {{ cycloid_job_ccm_ingestion_container_args }}\"{% else %}{{ cycloid_job_ccm_ingestion_container_args }}{% endif %}"

# docker exec -it cycloid-api bash -c "ls -l /etc/ssl/certs/ | grep DigiCertSHA2HighAssuranceServerCA.crt"

# If your server doesn't have internet access. Packages can't be install manually
# Set offline_setup: true to not install packages automatically
offline_setup: false

# If offline false, setup packages and docker
setup_packages: "{{ not offline_setup }}"
setup_docker: "{{ not offline_setup }}"

# Pull docker image when configuring the service
docker_pull: "{{ not offline_setup }}"

# If provided, Set Cycloid licence
cycloid_licence: ""

# Body request to set Cycloid licence via the API
cycloid_licence_body:
  key: "{{ cycloid_licence }}"

# Add cycloid public stack to the catalog repository. (can't create stack if licence is not activated)
cycloid_public_stacks: "{% if cycloid_licence != '' %}{{ not offline_setup }}{% else %}false{% endif %}"

# Create admin APIKEY on the first organization. (can't create stack if licence is not activated)
# APIKEY will be stored localy under {{playbook_dir}}/admin.apikey
cycloid_admin_apikey: "false"

# SSL
#
ssl_generate_selfsigned: true
cycloid_scheduler_ssl:
  crt: "{{ cycloid_local_datas_path }}/ssl/cycloid-scheduler.crt"
  key: "{{ cycloid_local_datas_path }}/ssl/cycloid-scheduler.key"
cycloid_creds_ssl:
  crt: "{{ cycloid_local_datas_path }}/ssl/cycloid-creds.crt"
  key: "{{ cycloid_local_datas_path }}/ssl/cycloid-creds.key"
cycloid_core_ssl:
  crt: "{{ cycloid_local_datas_path }}/ssl/cycloid-core.crt"
  key: "{{ cycloid_local_datas_path }}/ssl/cycloid-core.key"
cycloid_third_party:
  crt: "{{ cycloid_local_datas_path }}/ssl/cycloid-third-party.crt"
  key: "{{ cycloid_local_datas_path }}/ssl/cycloid-third-party.key"

#. default_ssl_subject_alt_name(optional, dict)
#+ a list of alternative common name to use for the self signed certs
#+ use `DNS` for a domain name and `IP` for a raw IP address
default_ssl_subject_alt_name:
  - DNS:127.0.0.1
  - DNS:cycloid
  - DNS:localhost
  - DNS:vault
  - DNS:concourse
  - DNS:minio
  - DNS:elasticsearch

#. ssl_subject_alt_name(optional, dict)
#+ a list of alternative common name to use in addition of the default ones for the self signed certs
#+ use `DNS` for a domain name and `IP` for a raw IP address
ssl_subject_alt_name: []

# HTTP proxy
http_proxy: ""
https_proxy: ""

extra_no_proxy: []

default_no_proxy:
  - "localhost"
  - "127.0.0.1"
  - "concourse-web"
  - "vault"
  - "{{ cycloid_api_dns | urlsplit('hostname') }}"
  - "{{ cycloid_console_dns | urlsplit('hostname') }}"
  - "{{ concourse_db_host }}"
  - "{{ cycloid_db_host }}"
  - "{{ cycloid_email_redis_host }}"
  - "{{ vault_url | urlsplit('hostname') }}"
  - "{{ concourse_url | urlsplit('hostname') }}"

no_proxy: "{{ (default_no_proxy + extra_no_proxy) | join(',') }}"

#
# Docker
#

cycloid_frontend_image: 661913936052.dkr.ecr.eu-west-1.amazonaws.com/youdeploy-frontend:prod
cycloid_api_image: 661913936052.dkr.ecr.eu-west-1.amazonaws.com/youdeploy-http-api:prod
cycloid_scheduler_sync_worker_keys_image: cycloid/concourse-team-authorized-key-sync:latest
concourse_db_image: postgres:9.6
cycloid_cache_image: redis:6.0.9
cycloid_db_image: mysql:8.0.21
# If mysql 8.x nativ auth need to be defined
cycloid_db_container_cmd_mysql8: "--default-authentication-plugin=mysql_native_password"
cycloid_db_container_cmd: "{% if cycloid_db_image.startswith('mysql:8') %}{{ cycloid_db_container_cmd_mysql8 }}{% endif %}"
concourse_web_image: concourse/concourse:7.8.3
vault_image: vault:1.5.4


#
# Concourse
#
concourse_url: "https://{{ hostvars[groups['cycloid_scheduler'][0]]['ansible_default_ipv4']['address'] }}"
concourse_port: 8443
# concourse_peer_address: must be specified IP used to reach the individual web node, from other web nodes.
concourse_peer_address: "{{ ansible_default_ipv4.address }}"
concourse_external_url: "{{ concourse_url }}:{{ concourse_port }}"
concourse_config_path: "{{ cycloid_install_path }}/concourse"
concourse_db_path: "{{ cycloid_install_path }}/concourse-db"
cycloid_smtp_path: "{{ cycloid_install_path }}/cycloid-smtp"
cycloid_cache_path: "{{ cycloid_install_path }}/cycloid-cache"
concourse_authorized_worker_keys_path: "authorized_worker_keys"
concourse_team_authorized_worker_keys_path: "team_authorized_worker_keys.yml"
concourse_host_key_path: "host_key"
concourse_session_signing_key_path: "session_signing_key"
concourse_db_password: "Deraephoh9aay4Aide4phoS7xej1xi5m"
concourse_db_host:  "{{ hostvars[groups['cycloid_scheduler_db'][0]]['ansible_default_ipv4']['address'] }}"
concourse_db_user: concourse
concourse_db_name: concourse
concourse_auth_user: admin
concourse_auth_password: admin

# disable|require|verify-ca|verify-full
concourse_db_sslmode: disable

# Extra env vars to pass to scheduler container
cycloid_scheduler_extra_env: {}


# Concourse keys
#concourse_session_signing_key:
#concourse_host_key:
#concourse_authorized_worker_keys:
#  - name: foo
#    key: ssh-rsa ...
# By default we will look for local files under keys directory
concourse_session_signing_key: "{{lookup('file', 'keys/id_rsa')}}"
concourse_host_key: "{{lookup('file', 'keys/id_rsa')}}"
concourse_authorized_worker_keys:
  - "{{lookup('file', 'keys/id_rsa.pub')}}"

#
# Vault
#
vault_config_path: "{{ cycloid_install_path }}/vault"
vault_config:
  storage:
    file:
       path: /vault/file
  ui: true
  listener:
    tcp:
      address: "0.0.0.0:8200"
      tls_disable: "0"
      tls_cert_file: "/vault/config/ssl.crt"
      tls_key_file:  "/vault/config/ssl.key"
  default_lease_ttl: "168h"
  max_lease_ttl: "720h"
# External vault url used by others services
vault_url: https://{{ hostvars[groups['cycloid_creds'][0]]['ansible_default_ipv4']['address'] }}:8200

# Copy the vault secret key on the vault server and update vault service to automatically unseal at startup
vault_auto_unseal: true
vault_unseal_cmd: "{{ vault_config_path }}/unseal.sh"
vault_start_post: "{% if vault_auto_unseal|bool %}{{ vault_unseal_cmd }}{% endif %}"

#
# Nginx
#

cycloid_nginx_path: "{{ cycloid_install_path }}/nginx"
cycloid_nginx_image: nginx:1.19.4

# Nginx proxy_pass url used for cycloid api vhost. Most of the case it shouldn't be changed.
cycloid_nginx_api_proxy_pass: "http://cycloid-api:3001"

# Nginx proxy_pass url used for cycloid console/frontend vhost. Most of the case it shouldn't be changed.
cycloid_nginx_console_proxy_pass: "http://cycloid-frontend"

#
# Cycloid
#

cycloid_initial_user:
  username: "admin"
  email: "disabled@no-email.cycloid"
  password: "Ch4ngm3pls"
  given_name: admin
  family_name: cycloid

cycloid_initial_organization_name: Cycloid
cycloid_initial_organization_canonical: "{{ cycloid_initial_organization_name|lower|regex_replace('[^a-z0-9\\-_]') }}"
cycloid_initial_organization:
    name: "{{ cycloid_initial_organization_name }}"
    canonical: "{{ cycloid_initial_organization_canonical }}"


#cycloid_initial_catalog_cred:
#    name: Catalog credential
#    type: ssh
#    path: ssh_catalog
#    raw:
#        # use a dummy ssh key by default to provide a valid SSH private key format
#        ssh_key: |-
#            -----BEGIN RSA PRIVATE KEY-----
#            -----END RSA PRIVATE KEY-----

cycloid_initial_service_catalog:
    name: Cycloid stacks
    canonical: cycloid-stacks
    url: https://github.com/cycloid-community-catalog/public-stacks
    branch: master

cycloid_db_password: "chovoh6gahti5ohP0AiF6eex6evoonie"
# cycloid_db_host: cycloid-db
# Get the address of the first defined host in cycloid_db group
cycloid_db_host: "{{ hostvars[groups['cycloid_db'][0]]['ansible_default_ipv4']['address'] }}"

cycloid_db_port: 3306
cycloid_db_user: cycloid
cycloid_db_name: cycloid
cycloid_db_path: "{{ cycloid_install_path }}/cycloid-db"

cycloid_email_smtp_svr_addr: "{{ hostvars[groups['smtp_server'][0]]['ansible_default_ipv4']['address'] }}:1025"
# The following example will rely on a smtp server installed locally on the host
#cycloid_email_smtp_svr_addr: "{{ ansible_docker0['ipv4']['address'] }}:25"

cycloid_email_smtp_username: admin
cycloid_email_smtp_password: admin
cycloid_email_addr_from: noreply@cycloid.io
cycloid_email_addr_return_path: admin+ydbounce@cycloid.io
cycloid_email_redis_host: "{{ hostvars[groups['cycloid_cache'][0]]['ansible_default_ipv4']['address'] }}"
cycloid_email_redis_port: 6379
cycloid_email_redis_db: 0
# Allow insecure TLS/SSL with email. Usefull when using local postfix as relayhost with selfsigned certs
cycloid_email_skip_tls_check: false

# asynqmon is used to debug redis worker queue. Set true to install it
cycloid_cache_mon_install: false
cycloid_cache_mon_image: hibiken/asynqmon:latest
cycloid_cache_mon_port: 5678

cycloid_jwt_key_1: 2f2122de-63f2-4eec-9c6f-c6abb3e1f007:7cdyHps2tYDp6e7VKPEstE5sDMQbK6WLyN3GmTsF7x7QpE6ZP5ra6yfVSkvXakbB
cycloid_crypto_signing_key: totally-random-secret-key

# iam credential to get ecr images
cycloid_ecr_access_key: "{{ lookup('env','AWS_ACCESS_KEY_ID') | default(omit)}}"
cycloid_ecr_secret_key: "{{ lookup('env','AWS_SECRET_ACCESS_KEY') | default(omit)}}"

#cycloid_api_container_links: []
#concourse_web_container_links: []

cycloid_use_api_via_console: True
cycloid_api_dns: cycloid-api
cycloid_api_base_url: "{%- if cycloid_use_api_via_console -%}{{cycloid_console_base_url}}/api{%- else -%}https://{{cycloid_api_dns}}{%- endif -%}"
cycloid_console_dns: cycloid-console
cycloid_console_base_url: "https://{{ cycloid_console_dns }}"

# Allow additional Origins to request the API. Multiple Origins can be specified using a comma ','.
# e.g, cycloid_api_cors_allowed_origins: "https://domain1.tld,http://domain2.tld"
# By default, the {{ cycloid_console_base_url }} is already allowed.
cycloid_api_cors_allowed_origins: ""

#
# minio
#

#. minio_version(optional, string): "latest"
#+ docker tag image to use, default latest
minio_version: latest

#. minio_port(optional, int): 9000
#+ MinIO port, default to 9000
minio_port: 9000

#. minio_access_key(required): str
#+ the aws-like access key
minio_access_key: AKIAIOSFODNN7EXAMPLE

#. minio_secret_key(required): str
#+ the aws-like secret key
minio_secret_key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY

#. minio_browser(optional, string): off
#+ uncomment to enable browser interface
# minio_browser: on

#. minio_config_path(optional, string): "{{ cycloid_install_path }}/minio"
#+ host directory used to store config/datas used by the container
minio_config_path: "{{ cycloid_install_path }}/minio"


# Keep env include var as legacy compatibility
env: prod

###########################
# report.yml playbook     #
###########################

cycloid_report_path: "/tmp/cycloid-report"
cycloid_report_local_path: "/tmp/cycloid-report-local"
cycloid_report_sensitive: false
cycloid_report_curl_timeout: 4

#
# Azure AD integration
#

#. azure_ad_tenant_id(optional, string): ""
#+ the tenant ID of Azure AD
azure_ad_tenant_id: ""

#. azure_ad_client_id(optional, string): ""
#+ the client ID of Azure AD
azure_ad_client_id: ""

#
# Google Oauth integration
#

#. google_client_id(optional, string): ""
#+ the client ID of Google
google_client_id: ""

#. google_client_secret(optional, string): ""
#+ the client secret of Google
google_client_secret: ""

#
# Github Oauth integration
#

#. github_client_secret(optional, string): "https://api.github.com"
#+ Use api github by default when oauth enabled. Need to be changed if using GitHub Enterprise.
github_host_address: "{%- if github_client_id != '' -%}https://api.github.com{%- endif -%}"

#. github_client_id(optional, string): ""
#+ the client ID of Github
github_client_id: ""

#. github_client_secret(optional, string): ""
#+ the client secret of Github
github_client_secret: ""

#
# elasticsearch
#

#. elasticsearch_basic_auth(option, bool): true
#. enable elasticsearch basic authentication
elasticsearch_basic_auth: true

#. elasticsearch_tls(optional, bool): true
#+ enable TLS on REST interface
elasticsearch_tls: true

#. elasticsearch_port_node(optional, int): 9300
#+ the node port of elasticsearch
elasticsearch_port_node: 9300

#. elasticsearch_port_api(optional, int): 9200
#+ the API port of elasticsearch
elasticsearch_port_api: 9200

#. elasticsearch_version(option, string): 7.6.2
#+ elasticsearch version to pull from hub.docker.com
elasticsearch_version: 7.6.2

#. elasticsearch_config_path(optional, string): /opt/cycloid/elasticsearch
#+ the path to store elasticsearch configuration
elasticsearch_config_path: "{{ cycloid_install_path }}/elasticsearch"

#. cycloid_elasticsearch_default(optional, string):
#+ the default credential to access elasticsearch with 'elastic' user
cycloid_elasticsearch_default:
    name: elasticsearch default
    type: elasticsearch
    path: elasticsearch_default
    raw:
      username: elastic
      password: NmM5NmIwNmEwM2Q0NmYwNDYyMDgzZGFj

# Docker has issues with Debain 10 Buster nftables that impact access from containers to external.
# Workaround is to revert to iptables-legacy by setting use_iptables_legacy: true
# https://github.com/geerlingguy/ansible-role-docker/issues/189
use_iptables_legacy: false


###########################
# SAML2 authentification
###########################
# Enabled SAML auth on Cyclid API.
saml_auth_enabled: false

# By default SAML3 files should be stored under saml/{cycloid-saml-sp.crt, ycloid-saml-sp.key, idp-metadata}

# Url to get your xml identity provider federation metadata file. If defined, do not provide saml_idp_metadata_file
saml_idp_metadata_url: ""
# Name of the Public certificate to use in cycloid
saml_sp_certificate_file: "cycloid-saml-sp.crt"
# Name of the certificate private key to use in cycloid
saml_sp_private_key_file: "cycloid-saml-sp.key"
# Name of your xml identity provider federation metadata file. It could also be provided as an url with saml_idp_metadata_url
saml_idp_metadata_file: "idp-metadata"



# Ansible Local path where your saml certs/metadata are stored
saml_local_path: "{{ cycloid_local_datas_path }}/saml"

# Path where saml certs will be stored on the host
saml_config_path: "{{ cycloid_install_path }}/saml"

# SAML2 api internal path. It shouldn't be changed. Following path will be used when SAML enabled with saml_auth_enabled: true.
saml_sp_certificate_path: "{%- if saml_auth_enabled -%}/secrets/saml/{{ saml_sp_certificate_file }}{%- endif -%}"
saml_sp_private_key_path: "{%- if saml_auth_enabled -%}/secrets/saml/{{ saml_sp_private_key_file }}{%- endif -%}"
saml_idp_metadata_path: "{%- if saml_auth_enabled and saml_idp_metadata_url == '' -%}/secrets/saml/{{ saml_idp_metadata_file }}{%- endif -%}"


###########################
# Cost Explorer / Cloud Cost Management feature (api params)
###########################

# Elasticsearch variable used for Cost Explorer / Cloud Cost Management access
cost_explorer_es_url: ""
cost_explorer_es_username: ""
cost_explorer_es_password: ""
cost_explorer_es_insecure_skip_tls: true # ignore certificate errors if there are any
cost_explorer_ingestion_schedule: "*-*-* 00:00:00" # schedule for the timer related to cycloid-job-ccm-ingestion_container service
#cost_explorer_es_ca_cert: "" # PEM-formatted CA certificate of Elasticsearch

# Share host saml file with container. It shouldn't be changed.
container_volumes_saml: "{%- if saml_auth_enabled -%}{{ saml_config_path }}:/secrets/saml{%- endif -%}"

#
# Monitoring
#
worker_metrics_enabled: false