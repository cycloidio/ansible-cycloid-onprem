---
##########
# Common #
##########

#. cycloid_console_dns(required, string): ""
#+ Resolvable domain name from the instance and externally to use Cycloid console.
cycloid_console_dns: cycloid-console

#. cycloid_api_dns(optional, string): ""
#+ Resolvable domain name from the instance and externally to use Cycloid API.
#+ If not defined, proxypass from cycloid_console_dns will be used.
cycloid_api_dns: cycloid-api

cycloid_api_provisioning: True

#. cycloid_initial_user(required, map):
#+ Cycloid initial user details.
cycloid_initial_user:
  username: "admin"
  email: "disabled@no-email.cycloid"
  password: "Ch4ngm3pls"
  given_name: admin
  family_name: cycloid

#. cycloid_initial_user(optional, string): "Cycloid"
#+ First Cycloid organization name.
cycloid_initial_organization_name: Cycloid

#. cycloid_api_log_level(optional, string): "INFO"
#+ Sets the log level for Cycloid API.
cycloid_api_log_level: "INFO"

#. cycloid_licence(optional, string): ""
#+ If provided, initialize Cycloid with the licence
cycloid_licence: ""

#. cycloid_frontend_version(optional, string): "latest-public"
#+ Cycloid Frontend version
cycloid_frontend_version: "latest-public"

#. cycloid_api_version(optional, string): "latest-public"
#+ Cycloid API version
cycloid_api_version: "latest-public"

#. cycloid_crypto_signing_key(required, string):
#+ Define a cryptographic signing key within the Cycloid platform.
cycloid_crypto_signing_key: totally-random-secret-key

#. cycloid_jwt_key_1(required, string):
#+ Key used to sign all the API JWT and External Backend inventory token. Format is UUID:RANDOM
# Example to generate: echo "$(< /proc/sys/kernel/random/uuid):$(< /dev/urandom tr -dc A-Za-z0-9 | head -c64)"
cycloid_jwt_key_1: "2f2122de-63f2-4eec-9c6f-c6abb3e1f007:7cdyHps2tYDp6e7VKPEstE5sDMQbK6WLyN3GmTsF7x7QpE6ZP5ra6yfVSkvXakbB"

#
# Cycloid DB
#

#. cycloid_db_host(required, string): "{{ hostvars[groups['cycloid_db'][0]]['ansible_default_ipv4']['address'] }}"
#+ Specifies the hostname or IP address of the Cycloid database server.
#+ by default Get the address of the first defined host in cycloid_db group
cycloid_db_host: "{{ hostvars[groups['cycloid_db'][0]]['ansible_default_ipv4']['address'] }}"
#. cycloid_db_port(required, string): "3306"
#+ Defines the port number on which the Cycloid database server is listening.
cycloid_db_port: 3306
#. cycloid_db_user(required, string): "cycloid"
#+ Specifies the username for the Cycloid database.
cycloid_db_user: cycloid
#. cycloid_db_password(required, string): "Ch4ngm3pls"
#+ Defines the password for accessing the Cycloid database.
cycloid_db_password: "Ch4ngm3pls"
#. cycloid_db_name(optional, string): "cycloid"
#+ Defines the name of the Cycloid database.
cycloid_db_name: cycloid

#
# Concourse
#

#. concourse_url(required, string): "https://{{ hostvars[groups['cycloid_scheduler'][0]]['ansible_default_ipv4']['address'] }}"
#+ Specifies the URL where Concourse CI can be accessed from the Cycloid API
concourse_url: "https://{{ hostvars[groups['cycloid_scheduler'][0]]['ansible_default_ipv4']['address'] }}"
#. concourse_auth_user(required, string): "admin"
#+ Defines the username for authenticating with Concourse CI.
concourse_auth_user: admin
#. concourse_auth_password(required, string): "Ch4ngm3pls"
#+ Defines the password for the Concourse CI user.
concourse_auth_password: Ch4ngm3pls
#. concourse_log_level(optional, string): "info"
#+ Sets the log level for Concourse CI.
concourse_log_level: info
#. concourse_db_host(required, string): ""
#+ Specifies the hostname or IP address of the Concourse CI database server.
concourse_db_host: "{{ hostvars[groups['cycloid_scheduler_db'][0]]['ansible_default_ipv4']['address'] }}"
#. concourse_db_port(required, string): "5432"
#+ Defines the port number on which the Concourse CI database server is listening.
concourse_db_port: "5432"
#. concourse_db_user(required, string): "concourse"
#+ Specifies the username for the Concourse CI database.
concourse_db_user: concourse
#. concourse_db_password(required, string): "Ch4ngm3pls"
#+ Defines the password for accessing the Concourse CI database.
concourse_db_password: "Ch4ngm3pls"
#. concourse_db_name(optional, string): "concourse"
#+ Defines the name of the Concourse CI database.
concourse_db_name: concourse

#
# Vault/Secret
#

#. vault_url(required, string): "https://{{ hostvars[groups['cycloid_creds'][0]]['ansible_default_ipv4']['address'] }}:8200"
#+ External vault url used by others services.
vault_url: https://{{ hostvars[groups['cycloid_creds'][0]]['ansible_default_ipv4']['address'] }}:8200

#
# Email
#

#. cycloid_email_smtp_svr_addr(required, string): "{{ hostvars[groups['smtp_server'][0]]['ansible_default_ipv4']['address'] }}:1025"
#+ Specifies the address of the SMTP server used for sending emails.
# The following example will rely on a smtp server installed locally on the host
# cycloid_email_smtp_svr_addr: "{{ ansible_docker0['ipv4']['address'] }}:25"
cycloid_email_smtp_svr_addr: "{%- if 'smtp_server' in groups -%}{{ hostvars[groups['smtp_server'][0]]['ansible_default_ipv4']['address'] }}:1025{%- endif -%}"
#. cycloid_email_smtp_username(required, string): "admin"
#+ Defines the username for SMTP authentication.
cycloid_email_smtp_username: admin
#. cycloid_email_smtp_password(required, string): "Ch4ngm3pls"
#+ Defines the password for SMTP authentication.
cycloid_email_smtp_password: Ch4ngm3pls
#. cycloid_email_addr_from(required, string): "noreply@cycloid.io"
#+ Specifies the email address that will appear in the "From" field of emails sent by Cycloid.
cycloid_email_addr_from: noreply@cycloid.io
#. cycloid_email_addr_return_path(required, string): "admin+bounce@cycloid.io"
#+ Defines the return email for bounced emails.
cycloid_email_addr_return_path: admin+bounce@cycloid.io
#. cycloid_email_skip_tls_check(optional, bool): "false"
#+ Allow insecure TLS/SSL with email. Usefull when using local postfix as relayhost with selfsigned certs
cycloid_email_skip_tls_check: false

# cycloid_email_redis* defined to keep retro compatibility.
# In the future these variable will be depreciate and replaced by cycloid_cache_host and cycloid_cache_port
cycloid_email_redis_host: "{{ hostvars[groups['cycloid_cache'][0]]['ansible_default_ipv4']['address'] }}"
cycloid_email_redis_port: 6379

#. cycloid_cache_host(required, string): "{{ hostvars[groups['cycloid_cache'][0]]['ansible_default_ipv4']['address'] }}"
#+ Specifies the hostname or IP address of Redis server.
#+ by default Get the address of the first defined host in cycloid_cache group
cycloid_cache_host: "{{ cycloid_email_redis_host }}"
#. cycloid_cache_port(optional, string): "6379"
#+ Specifies the port to reach Redis server.
cycloid_cache_port: "{{ cycloid_email_redis_port }}"
#. cycloid_cache_username(optional, string): "default"
#+ The username for authenticating with the Redis cache server. Set to empty "" to disable authentication.
cycloid_cache_username: default
#. cycloid_cache_password(optional, string): "Ch4ngm3pls"
#+ The password for authenticating with the Redis cache server. Set to empty "" to disable authentication.
cycloid_cache_password: "Ch4ngm3pls"
#. cycloid_cache_schema(optional, string): "rediss"
#+ Redis URI schema. Use "rediss" for Redis connection over a secure (SSL/TLS) connection.
cycloid_cache_schema: "{%- if cycloid_cache_tls_enabled|bool -%}rediss{%- else -%}redis{%- endif -%}"
#. cycloid_cache_insecure_skip_tls(optional, bool): "true"
#+ Allow insecure TLS/SSL with Redis. Usefull when using local redis with selfsigned certs
cycloid_cache_insecure_skip_tls: true

#. cost_explorer_es_url(optional, string): "{{elasticsearch_schema}}://{{ hostvars[groups['elasticsearch'][0]]['ansible_default_ipv4']['address'] }}:{{elasticsearch_port_api}}"
#+ Defines the URL for connecting to the Elasticsearch service used by the Cost Explorer.
cost_explorer_es_url: "{%- if use_local_elasticsearch|bool -%}{{elasticsearch_schema}}://{{ hostvars[groups['elasticsearch'][0]]['ansible_default_ipv4']['address'] }}:{{elasticsearch_port_api}}{%- endif -%}"
#. cost_explorer_es_username(optional, string): "elastic"
#+ Specifies the username for authenticating with the Elasticsearch service.
cost_explorer_es_username: "{%- if use_local_elasticsearch|bool -%}{{ cycloid_elasticsearch_user }}{%- endif -%}"
#. cost_explorer_es_password(optional, string): "Ch4ngm3pls"
#+ Defines the password for authenticating with the Elasticsearch service.
cost_explorer_es_password: "{%- if use_local_elasticsearch|bool -%}{{ cycloid_elasticsearch_password }}{%- endif -%}"
#. cost_explorer_es_insecure_skip_tls(optional, bool): true
#+ Configures whether to ignore TLS certificate errors when connecting to Elasticsearch.
cost_explorer_es_insecure_skip_tls: true # ignore certificate errors if there are any
#. cost_explorer_ingestion_schedule(optional, string): "*-*-* 00:00:00"
#+ Sets the schedule for CostExplorer Ingestion jobs.
# Every midnight
cost_explorer_ingestion_schedule: "*-*-* 00:00:00"

#
# Cost Estimation
#

#
#. cycloid_job_cost_estimation_injection_aws(optional, bool): "false"
#+ Ingest the price of the AWS cloud provider for use in the Cost Estimation feature.
cycloid_job_cost_estimation_injection_aws: false
#. cycloid_job_cost_estimation_injection_azure(optional, bool): "false"
#+ Ingest the price of the Azure cloud provider for use in the Cost Estimation feature.
cycloid_job_cost_estimation_injection_azure: false
#. cycloid_job_cost_estimation_injection_gcp(optional, bool): "false"
#+ Ingest the price of the GCP cloud provider for use in the Cost Estimation feature.
cycloid_job_cost_estimation_injection_gcp: false
#. cost_estimation_gcp_cred_json(optional, string): ""
#+ GCP json credential used to reach GCP pricing datas.
cost_estimation_gcp_cred_json: ""
cost_estimation_gcp_project: ""
#. cost_estimation_ingestion_schedule(optional, string): "Sun *-*-* 00:00:00"
#+ Sets the schedule for CostEstimation Ingestion jobs.
# Every sunday midnight
cost_estimation_ingestion_schedule: "Sun *-*-* 00:00:00"

#
# KPI import
#

# OnCalendar example
# Every Minute	*-*-* *:*:00
# Every 2 minute	*-*-* *:*/2:00
# Every 5 minutes	*-*-* *:*/5:00
# Every 15 minutes	*-*-* *:*/15:00
# Every quarter hour	*-*-* *:*/15:00
# Every 30 minutes	*-*-* *:*/30:00
# Every half an hour	*-*-* *:*/30:00
# Every 60 minutes	*-*-* */1:00:00
# Every 1 hour	*-*-* *:00:00
# Every 2 hour	*-*-* */2:00:00
# Every 3 hour	*-*-* */3:00:00
# Every other hour	*-*-* */2:00:00
# Every 6 hour	*-*-* */6:00:00
# Every 12 hour	*-*-* */12:00:00
# Hour Range	*-*-* 9-17:00:00
# Between certain hours	*-*-* 9-17:00:00
# Every day at midnight	*-*-* 00:00:00
# Every sunday	Sun *-*-* 00:00:00
# Every friday	Fri *-*-* 01:00:00
# Every friday at midnight	Fri *-*-* 00:00:00
# Every saturday	Sat *-*-* 00:00:00
# Every weekday	Mon...Fri *-*-* 00:00:00
# weekends only	Sat,Sun *-*-* 00:00:00
# Every month	* *-*-01 00:00:00
# Every quarter	* *-01,04,07,10-01 00:00:00
# Every 6 months	* *-01,07-01 00:00:00
# Every year	* *-01-01 00:00:00

# Every 1 hour
kpi_import_schedule: "*-*-* *:00:00"

#####################
# advanced settings #
#####################

#. validate(optional, bool): true
#+ Wait and validate running services via validate.yml
validate: true

#. validate_only(optional, bool): false
#+ If true, only run validate.yml and skip other tasks
validate_only: false

#. uninstall(optional, bool): false
#+ /!\ Set to true only if you want to uninstall cycloid /!\
uninstall: false

#. ca_certificates_container_shared(optional, bool): false
#+ Share your rootCA from the host to containers
ca_certificates_container_shared: false

#. cycloid_packages(optional, map): debian
#+ List of packages to install depending of the OS
cycloid_packages:
  debian:
    - python3-pip
    - default-mysql-client
    - python3-setuptools
    - gnupg2
    - pass
    - netcat
  debian-10:
    - python3-pip
    - default-mysql-client
    - python-setuptools
    - gnupg2
    - pass
    - netcat
    - python-backports.ssl-match-hostname
  redhat:
    - python3-pip
    - mysql
    - gnupg2
    - nmap-ncat
  centos-7:
    - python3-pip
    - mysql
    - gnupg2
    - nmap-ncat

#. container_args_extra(optional, string): ""
#+ Used to give extra argument to containers. Example to override domain server "--dns 172.17.0.1"
container_args_extra: ""

#. offline_setup(optional, bool): false
#+ Set true to not install packages automatically.
offline_setup: false

#. cycloid_public_stacks(optional, bool): true
#+ Create a catalog repository with Cycloid Public Stacks. (`cycloid_licence` need to be defined)
cycloid_public_stacks: "{% if cycloid_licence != '' %}{{ not offline_setup }}{% else %}false{% endif %}"

#. cycloid_admin_apikey(optional, bool): false
#+ Create admin APIKEY on the first organization. APIKEY will be stored localy under ``{{playbook_dir}}/admin.apikey`. (`cycloid_licence` need to be defined)
cycloid_admin_apikey: "false"

#. ssl_subject_alt_name(optional, list): []
#+ Alternative common name to use in addition of the default ones for the self signed certs . Use `DNS` for a domain name and `IP` for a raw IP address.
ssl_subject_alt_name: []

# HTTP proxy
#. http_proxy(optional, string): ""
#+ Specify the proxy server for HTTP connections. When set, all HTTP requests will be routed through the specified proxy server.
http_proxy: ""
#. https_proxy(optional, string): ""
#+ Specify the proxy server for HTTPS connections. When set, all HTTPS requests will be routed through the specified proxy server.
https_proxy: ""

#. extra_no_proxy(optional, list): []
#+ Specify a list of domain names, IP addresses, or network blocks that should bypass the proxy
extra_no_proxy: []

#. cycloid_cache_mon_install(optional, bool): false
#+ Asynqmon is used to debug redis worker queue. Set true to install it
cycloid_cache_mon_install: false

#. vault_config(optional, map):
#+ Override Vault config such storage.
vault_config:
  storage:
    file:
      path: /vault/file
  ui: true
  listener:
    tcp:
      address: "0.0.0.0:8200"
      tls_disable: "0"
      tls_cert_file: "/vault/config/ssl.crt"
      tls_key_file: "/vault/config/ssl.key"
  default_lease_ttl: "168h"
  max_lease_ttl: "720h"

#
# Azure AD integration
#

#. azure_ad_tenant_id(optional, string): ""
#+ The tenant ID of Azure AD
azure_ad_tenant_id: ""

#. azure_ad_client_id(optional, string): ""
#+ The client ID of Azure AD
azure_ad_client_id: ""

#
# Google Oauth integration
#

#. google_client_id(optional, string): ""
#+ The client ID of Google
google_client_id: ""

#. google_client_secret(optional, string): ""
#+ The client secret of Google
google_client_secret: ""

#
# Github Oauth integration
#

#. github_client_secret(optional, string): "https://api.github.com"
#+ Use api github by default when oauth enabled. Need to be changed if using GitHub Enterprise.
github_host_address: "{%- if github_client_id != '' -%}https://api.github.com{%- endif -%}"

#. github_client_id(optional, string): ""
#+ The client ID of Github
github_client_id: ""

#. github_client_secret(optional, string): ""
#+ The client secret of Github
github_client_secret: ""

###########################
# SAML2 authentification
###########################

# By default SAML3 files should be stored under saml/{cycloid-saml-sp.crt, ycloid-saml-sp.key, idp-metadata}

#. saml_auth_enabled(optional, bool): false
#+ Enabled SAML auth on Cyclid API.
saml_auth_enabled: false
#. saml_idp_metadata_url(optional, string): ""
#+ URL to get your XML Identity Provider federation metadata file. If defined, do not provide saml_idp_metadata_file.
saml_idp_metadata_url: ""
#. saml_sp_certificate_file(optional, string): "cycloid-saml-sp.crt"
#+ Name of the Public certificate stored in saml_local_path to use in cycloid.
saml_sp_certificate_file: "cycloid-saml-sp.crt"
#. saml_sp_private_key_file(optional, string): "cycloid-saml-sp.key"
#+ Name of the certificate private key stored in saml_local_path to use in cycloid.
saml_sp_private_key_file: "cycloid-saml-sp.key"
#. saml_idp_metadata_file(optional, string): "idp-metadata"
#+ Name of your xml identity provider federation metadata file. It could also be provided as an url with saml_idp_metadata_url.
saml_idp_metadata_file: "idp-metadata"

############
# internal #
############

# Dynamic variables to determine if the component should be installed.
# Setup Cycloid frontend, Backend and Nginx
setup_cycloid_core: "{{ 'cycloid_core' in group_names }}"
# Setup Concourse
setup_cycloid_scheduler: "{{ 'cycloid_scheduler' in group_names }}"
# Setup Postgres (Concourse DB)
setup_cycloid_scheduler_db: "{{ 'cycloid_scheduler_db' in group_names }}"
# Setup Mysql (Cycloid DB)
setup_cycloid_db: "{{ 'cycloid_db' in group_names }}"
# Setup Redis
setup_cycloid_cache: "{{ 'cycloid_cache' in group_names }}"
# Setup Vault
setup_cycloid_creds: "{{ 'cycloid_creds' in group_names }}"
# Setup MinIo (s3-like remote storage)
setup_minio: "{{ 'minio' in group_names }}"
# Setup ElasticSearch
setup_elasticsearch: "{{ 'elasticsearch' in group_names }}"
# Setup fake SMTP (it will start a mailhog smtpd server to satisfy Cycloid requirements)
setup_smtp_server: "{{ 'smtp_server' in group_names }}"

# Global host variable to indicate if

# specify if cycloid should use or not the local elasticsearch installed
use_local_elasticsearch: "{%- if 'elasticsearch' in groups and groups['elasticsearch'] | length > 0 -%}true{%- else -%}false{%- endif -%}"
use_local_smtp_server: "{%- if 'smtp_server' in groups and groups['smtp_server'] | length > 0 -%}true{%- else -%}false{%- endif -%}"

# Local path used to store certificats
cycloid_local_datas_path: "{{ playbook_dir }}/datas"

# Path used to install Cycloid
cycloid_install_path: /opt/cycloid

# Get the list of packages to install from cycloid_packages
cycloid_packages_list: "{{ cycloid_packages[ansible_distribution | lower + '-' + ansible_distribution_major_version] | default(cycloid_packages[ansible_os_family | lower]) }}"

#
# Docker
#

# uses scaleway registry by default otherwise uses AWS
use_registry_scaleway: true

# iam credential to get ecr images
cycloid_aws_registry: 661913936052.dkr.ecr.eu-west-1.amazonaws.com
cycloid_ecr_access_key: "{{ lookup('env','AWS_ACCESS_KEY_ID') | default(omit)}}"
cycloid_ecr_secret_key: "{{ lookup('env','AWS_SECRET_ACCESS_KEY') | default(omit)}}"

# iam credential to get scaleway images
cycloid_scw_registry: "rg.fr-par.scw.cloud/cycloidio"
cycloid_scw_registry_access_key: "{{ lookup('env','SCALEWAY_ACCESS_KEY_ID') | default(omit)}}"
cycloid_scw_registry_secret_key: "{{ lookup('env','SCALEWAY_SECRET_ACCESS_KEY') | default(omit)}}"

cycloid_frontend_image: "{% if use_registry_scaleway|bool %}{{ cycloid_scw_registry }}/cycloid-frontend:{{ cycloid_frontend_version }}{% else %}{{ cycloid_aws_registry }}/youdeploy-frontend:{{ cycloid_frontend_version }}{% endif %}"
cycloid_api_image: "{% if use_registry_scaleway|bool %}{{ cycloid_scw_registry }}/cycloid-backend:{{ cycloid_api_version }}{% else %}{{ cycloid_aws_registry }}/youdeploy-http-api:{{ cycloid_api_version }}{% endif %}"

cycloid_scheduler_sync_worker_keys_image: cycloid/concourse-team-authorized-key-sync:latest
concourse_db_image: postgres:15.4
cycloid_cache_image: bitnami/redis:8.0.2
cycloid_db_image: bitnami/mysql:9.3.0
concourse_web_image: concourse/concourse:7.9.1
vault_image: hashicorp/vault:1.19
# https://hub.docker.com/_/nginx/tags
cycloid_nginx_image: nginx:1.28
cycloid_cache_mon_image: hibiken/asynqmon:latest
elasticsearch_image: elasticsearch:8.10.2
kibana_image: bitnami/kibana:8.10.2
minio_image: "minio/minio:latest"

cycloid_cache_mon_port: 5678

#
# containers ports
#

cycloid_api_port: 3001
cycloid_api_task_manager_port: 2112

# Chose to listen to one IP address or every IP address
cycloid_api_container_ports:
  - "0.0.0.0:{{ cycloid_api_port }}:3001"
  # - "{{ ansible_default_ipv4.address }}:3001:3001"
  # - "127.0.0.1:3001:3001"
cycloid_api_task_manage_container_ports:
  - "0.0.0.0:{{ cycloid_api_task_manager_port }}:2112"
cycloid_cache_container_ports:
  - "0.0.0.0:{{ cycloid_email_redis_port }}:6379"
  # - "{{ ansible_default_ipv4.address }}:{{ cycloid_email_redis_port }}:6379"
  # - "127.0.0.1:{{ cycloid_email_redis_port }}:6379"
vault_container_ports:
  - "0.0.0.0:8200:8200"
  # - "{{ ansible_default_ipv4.address }}:8200:8200"
  # - "127.0.0.1:8200:8200"
cycloid_db_container_ports:
  - "0.0.0.0:{{ cycloid_db_port }}:3306"
  # - "{{ ansible_default_ipv4.address }}:{{ cycloid_db_port }}:3306"
  # - "127.0.0.1:{{ cycloid_db_port }}:3306"
cycloid_frontend_container_ports:
  - "0.0.0.0:3000:80"
  # - "{{ ansible_default_ipv4.address }}:3000:80"
  # - "127.0.0.1:3000:80"
concourse_db_container_ports:
  - "0.0.0.0:{{ concourse_db_port }}:5432"
  # - "{{ ansible_default_ipv4.address }}:5432:5432"
  # - "127.0.0.1:5432:5432"
concourse_web_container_ports:
  - "0.0.0.0:2222:2222"
  - "0.0.0.0:8080:8080"
  - "0.0.0.0:{{ concourse_port }}:{{ concourse_port }}"
  # - "{{ ansible_default_ipv4.address }}:2222:2222"
  # - "127.0.0.1:2222:2222"
  # - "{{ ansible_default_ipv4.address }}:8080:8080"
  # - "127.0.0.1:8080:8080"
  # - "{{ ansible_default_ipv4.address }}:{{ concourse_port }}:{{ concourse_port }}"
  # - "127.0.0.1:{{ concourse_port }}:{{ concourse_port }}"
cycloid_nginx_container_ports:
  - "0.0.0.0:80:80"
  - "0.0.0.0:443:443"
  # - "{{ ansible_default_ipv4.address }}:80:80"
  # - "127.0.0.1:80:80"
  # - "{{ ansible_default_ipv4.address }}:443:443"
  # - "127.0.0.1:443:443"
cycloid_smtp_container_ports:
  - "0.0.0.0:1025:1025"
  - "0.0.0.0:8025:8025"
  # - "{{ ansible_default_ipv4.address }}:1025:1025"
  # - "127.0.0.1:1025:1025"
  # - "{{ ansible_default_ipv4.address }}:8025:8025"
  # - "127.0.0.1:8025:8025"
elasticsearch_container_ports:
  - "0.0.0.0:{{ elasticsearch_port_node }}:9300"
  - "0.0.0.0:{{ elasticsearch_port_api }}:9200"
  # - "{{ ansible_default_ipv4.address }}:{{ elasticsearch_port_node }}:9300"
  # - "127.0.0.1:{{ elasticsearch_port_node }}:9300"
  # - "{{ ansible_default_ipv4.address }}:{{ elasticsearch_port_api }}:9200"
  # - "127.0.0.1:{{ elasticsearch_port_api }}:9200"
minio_container_ports:
  - "0.0.0.0:{{ minio_port }}:9000"
  - "0.0.0.0:{{ minio_console_port }}:9001"
  # - "{{ ansible_default_ipv4.address }}:{{ minio_port }}:9000"
  # - "127.0.0.1:{{ minio_port }}:9000"
kibana_container_ports:
  - "0.0.0.0:{{ kibana_port }}:{{ kibana_port }}"

#
# Install your own rootCa on onprem servers
#

# where rootCA stored on serveurs depending of ansible_os_family
ca_certificates_path:
  debian: /usr/local/share/ca-certificates
  redhat: /etc/pki/ca-trust/source/anchors

# Local path used to upload your own root certificates to deploy on servers
ca_certificates_local_path: "{{ cycloid_local_datas_path }}/rootca/*"

# System command to update root certificates
ca_certificates_handler:
  debian: "/usr/sbin/update-ca-certificates"
  redhat: "/usr/bin/update-ca-trust"

# Certificates volumes to share on containers depending of ansible_os_family
container_volumes_ca_certificates_default:
  debian: "/usr/local/share/ca-certificates:/usr/local/share/ca-certificates"
  redhat: "/etc/pki/ca-trust/source/anchors:/usr/local/share/ca-certificates/anchors"

# If ca_certificates_container_shared, share CA volumes with containers
container_volumes_ca_certificates: "{% if ca_certificates_container_shared|bool %}{{ container_volumes_ca_certificates_default[ansible_os_family | lower] }}{% endif %}"
# If ca_certificates_container_shared, update-ca-certificates on containers
#update_ca_start_post: "{% if ca_certificates_container_shared %}/usr/sbin/update-ca-certificates{% endif %}"
container_args_update_ca: "{% if ca_certificates_container_shared|bool %}--entrypoint /bin/bash{% endif %}"

# If ca_certificates_container_shared, run update-ca before the /entrypoint
cycloid_api_container_cmd: '{% if ca_certificates_container_shared|bool %}-c "apk add --update --upgrade --no-cache ca-certificates && /usr/sbin/update-ca-certificates && /entrypoint"{% endif %}'
# docker exec -it cycloid-api bash -c "ls -l /etc/ssl/certs/ | grep DigiCertSHA2HighAssuranceServerCA.crt"

# SSL
#
ssl_generate_selfsigned: true
cycloid_scheduler_ssl:
  crt: "{{ cycloid_local_datas_path }}/ssl/cycloid-scheduler.crt"
  key: "{{ cycloid_local_datas_path }}/ssl/cycloid-scheduler.key"
cycloid_creds_ssl:
  crt: "{{ cycloid_local_datas_path }}/ssl/cycloid-creds.crt"
  key: "{{ cycloid_local_datas_path }}/ssl/cycloid-creds.key"
cycloid_core_ssl:
  crt: "{{ cycloid_local_datas_path }}/ssl/cycloid-core.crt"
  key: "{{ cycloid_local_datas_path }}/ssl/cycloid-core.key"
cycloid_redis_ssl:
  crt: "{{ cycloid_local_datas_path }}/ssl/cycloid-redis.crt"
  key: "{{ cycloid_local_datas_path }}/ssl/cycloid-redis.key"
cycloid_third_party:
  crt: "{{ cycloid_local_datas_path }}/ssl/cycloid-third-party.crt"
  key: "{{ cycloid_local_datas_path }}/ssl/cycloid-third-party.key"

#. default_ssl_subject_alt_name(optional, list)
#+ Alternative common name to use for the self signed certs use `DNS` for a domain name and `IP` for a raw IP address
default_ssl_subject_alt_name:
  - IP:127.0.0.1
  - DNS:cycloid
  - DNS:localhost
  - DNS:vault
  - DNS:concourse
  - DNS:minio
  - DNS:elasticsearch
  - DNS:redis

default_no_proxy:
  - "localhost"
  - "127.0.0.1"
  - "concourse-web"
  - "vault"
  - "{{ cycloid_api_dns | urlsplit('hostname') }}"
  - "{{ cycloid_console_dns | urlsplit('hostname') }}"
  - "{{ concourse_db_host }}"
  - "{{ cycloid_db_host }}"
  - "{{ cycloid_email_redis_host }}"
  - "{{ vault_url | urlsplit('hostname') }}"
  - "{{ concourse_url | urlsplit('hostname') }}"

no_proxy: "{{ (default_no_proxy + extra_no_proxy) | join(',') }}"

# If offline false, setup packages and docker
setup_packages: "{{ not offline_setup }}"
setup_docker: "{{ not offline_setup }}"

# Pull docker image when configuring the service
docker_pull: "{{ not offline_setup }}"

# Body request to set Cycloid licence via the API
cycloid_licence_body:
  key: "{{ cycloid_licence }}"

#
# Concourse
#

concourse_port: 8443
# concourse_peer_address: must be specified IP used to reach the individual web node, from other web nodes.
concourse_peer_address: "{{ ansible_default_ipv4.address }}"
concourse_external_url: "{{ concourse_url }}:{{ concourse_port }}"
concourse_config_path: "{{ cycloid_install_path }}/concourse"
concourse_db_path: "{{ cycloid_install_path }}/concourse-db"
cycloid_smtp_path: "{{ cycloid_install_path }}/cycloid-smtp"
cycloid_cache_path: "{{ cycloid_install_path }}/cycloid-cache"
cycloid_api_path: "{{ cycloid_install_path }}/cycloid-api"
concourse_authorized_worker_keys_path: "authorized_worker_keys"
concourse_team_authorized_worker_keys_path: "team_authorized_worker_keys.yml"
concourse_host_key_path: "host_key"
concourse_session_signing_key_path: "session_signing_key"

# disable|require|verify-ca|verify-full
concourse_db_sslmode: disable

# Extra env vars to pass to scheduler container
cycloid_scheduler_extra_env: {}

# Concourse keys
#concourse_session_signing_key:
#concourse_host_key:
#concourse_authorized_worker_keys:
#  - name: foo
#    key: ssh-rsa ...
# By default we will look for local files under keys directory
concourse_session_signing_key: "{{lookup('file', 'keys/id_rsa')}}"
concourse_host_key: "{{lookup('file', 'keys/id_rsa')}}"
concourse_authorized_worker_keys:
  - "{{lookup('file', 'keys/id_rsa.pub')}}"

#
# API
#

# If redis TLS, mount redis ca certificate as volume in the api container
container_api_volumes_redis_ca: '{%- if cycloid_cache_schema == "rediss" and not cycloid_cache_insecure_skip_tls|bool -%}{{ cycloid_api_path }}/redis-ca.crt:/secrets/redis-ca.crt{%- endif -%}'
# If redis TLS, define the REDIS_CA_CERT_FILE envvar
cycloid_api_redis_ca_cert_file: '{%- if cycloid_cache_schema == "rediss" and not cycloid_cache_insecure_skip_tls|bool -%}/secrets/redis-ca.crt{%- endif -%}'

#
# Vault
#
vault_config_path: "{{ cycloid_install_path }}/vault"

# Copy the vault secret key on the vault server and update vault service to automatically unseal at startup
vault_auto_unseal: true
vault_unseal_cmd: "{{ vault_config_path }}/unseal.sh"
vault_start_post: "{% if vault_auto_unseal|bool %}{{ vault_unseal_cmd }}{% endif %}"

#
# Nginx
#

cycloid_nginx_path: "{{ cycloid_install_path }}/nginx"

# Nginx proxy_pass url used for cycloid api vhost. Most of the case it shouldn't be changed.
cycloid_nginx_api_proxy_pass: "http://cycloid-api:{{ cycloid_api_port }}"

# Nginx proxy_pass url used for cycloid console/frontend vhost. Most of the case it shouldn't be changed.
cycloid_nginx_console_proxy_pass: "http://cycloid-frontend"

# Nginx enables the specified protocols (if not define, use default by nginx)
# cycloid_nginx_ssl_protocols: "TLSv1 TLSv1.1 TLSv1.2 TLSv1.3"

#
# Cycloid
#

cycloid_initial_organization_canonical: "{{ cycloid_initial_organization_name|lower|regex_replace('[^a-z0-9\\-_]') }}"
cycloid_initial_organization:
  name: "{{ cycloid_initial_organization_name }}"
  canonical: "{{ cycloid_initial_organization_canonical }}"

#cycloid_initial_catalog_cred:
#    name: Catalog credential
#    type: ssh
#    path: ssh_catalog
#    raw:
#        # use a dummy ssh key by default to provide a valid SSH private key format
#        ssh_key: |-
#            -----BEGIN RSA PRIVATE KEY-----
#            -----END RSA PRIVATE KEY-----

cycloid_initial_service_catalog:
  name: Cycloid stacks
  canonical: cycloid-stacks
  url: https://github.com/cycloid-community-catalog/public-stacks
  branch: master

cycloid_db_path: "{{ cycloid_install_path }}/cycloid-db"

# Path used inside mysql docker image to stora data.
# By default mysql use "/var/lib/mysql" but bitnami use "/bitnami/mysql"
cycloid_db_container_path: "/bitnami/mysql"

# default redis db
cycloid_email_redis_db: 0

# If no user or password given, assume auth is disabled
cycloid_cache_auth_disabled: "{% if cycloid_cache_username == '' or cycloid_cache_password == '' %}true{% else %}false{% endif %}"

# Enable TLS
cycloid_cache_tls_enabled: "true"

# Generate redis uri
cycloid_cache_uri: "{{ cycloid_cache_schema }}://{% if not cycloid_cache_auth_disabled|bool %}{{ cycloid_cache_username }}:{{ cycloid_cache_password }}@{% endif %}{{ cycloid_email_redis_host }}:{{ cycloid_email_redis_port }}/{{ cycloid_email_redis_db }}"

# Cache allow you to define redis envvars
cycloid_cache_env:
  REDIS_PASSWORD: "{{ cycloid_cache_password }}"
  REDIS_TLS_ENABLED: "{{ cycloid_cache_tls_enabled }}"
  # Use user/password authentication
  REDIS_TLS_AUTH_CLIENTS: "no"
  REDIS_TLS_CERT_FILE: "/bitnami/redis/ssl.crt"
  REDIS_TLS_KEY_FILE: "/bitnami/redis/ssl.key"
  REDIS_TLS_CA_FILE: "/bitnami/redis/ssl.crt"

#cycloid_api_container_links: []
#concourse_web_container_links: []

cycloid_api_base_url: '{%- if cycloid_api_dns == "cycloid-api" -%}{{cycloid_console_base_url}}/api{%- else -%}https://{{cycloid_api_dns}}{%- endif -%}'
cycloid_console_base_url: "https://{{ cycloid_console_dns }}"

# Allow additional Origins to request the API. Multiple Origins can be specified using a comma ','.
# e.g, cycloid_api_cors_allowed_origins: "https://domain1.tld,http://domain2.tld"
# By default, the {{ cycloid_console_base_url }} is already allowed.
cycloid_api_cors_allowed_origins: ""

#. cycloid_api_task_manager_enabled(optional, bool): true
#+ If true, split the Cycloid backend in 2 containers (API and task_manager/Worker)
cycloid_api_task_manager_enabled: true
#. cycloid_api_worker_run_internal(optional, bool): false
# Disable internal worker on API container.
cycloid_api_worker_run_internal: "{%- if cycloid_api_task_manager_enabled|bool -%}false{%- else -%}true{%- endif -%}"

# API call /user/login expect only email/pass properties.
# If more params, it fail
cycloid_login_user:
  email: "{{ cycloid_initial_user.email }}"
  password: "{{ cycloid_initial_user.password }}"

# Keep env include var as legacy compatibility
env: prod

#
# minio
#

#. minio_port(optional, int): 9000
#+ MinIO port, default to 9000
minio_port: 9000
minio_console_port: 9001

#. minio_root_user(required): str
#+ the aws-like access key
minio_root_user: AKIEXAMPLE

#. minio_secret_key(required): str
#+ the aws-like secret key
minio_root_password: EXAMPLEKEY

#. minio_browser(optional, string): off
#+ uncomment to enable browser interface
minio_browser: off

#. minio_config_path(optional, string): "{{ cycloid_install_path }}/minio"
#+ host directory used to store config/datas used by the container
minio_config_path: "{{ cycloid_install_path }}/minio"

#
# elasticsearch
#

#. elasticsearch_tls(optional, bool): true
#+ enable TLS on REST interface
elasticsearch_tls: true
elasticsearch_schema: "{%- if elasticsearch_tls -%}https{%- else -%}http{%- endif -%}"

# make sure to install mapper-murmur3 for CCM
elasticsearch_container_args: "--entrypoint /bin/bash"
elasticsearch_container_cmd: '-c "/usr/share/elasticsearch/bin/elasticsearch-plugin install mapper-murmur3 && /usr/local/bin/docker-entrypoint.sh"'

#. elasticsearch_port_node(optional, int): 9300
#+ the node port of elasticsearch
elasticsearch_port_node: 9300

#. elasticsearch_port_api(optional, int): 9200
#+ the API port of elasticsearch
elasticsearch_port_api: 9200

#. elasticsearch_config_path(optional, string): /opt/cycloid/elasticsearch
#+ the path to store elasticsearch configuration
elasticsearch_config_path: "{{ cycloid_install_path }}/elasticsearch"

#. elasticsearch_basic_auth(option, bool): true
#. enable elasticsearch basic authentication
elasticsearch_basic_auth: true
cycloid_elasticsearch_user: "elastic"
#. cycloid_elasticsearch_password(optional, string): ""
#+ the default credential to access elasticsearch with 'elastic' user
cycloid_elasticsearch_password: "NmM5NmIwNmEwM2Q0NmYwNDYyMDgzZGFj"
#. cycloid_elasticsearch_default(optional, string):
#+ the default credential to access elasticsearch with 'elastic' user
cycloid_elasticsearch_default:
  name: elasticsearch default
  type: elasticsearch
  path: elasticsearch_default
  raw:
    username: "{{ cycloid_elasticsearch_user }}"
    password: "{{ cycloid_elasticsearch_password }}"

###########################
# kibana
###########################
kibana_port: 5601
kibana_config_path: "{{ cycloid_install_path }}/kibana"

# Docker has issues with Debain 10 Buster nftables that impact access from containers to external.
# Workaround is to revert to iptables-legacy by setting use_iptables_legacy: true
# https://github.com/geerlingguy/ansible-role-docker/issues/189
use_iptables_legacy: false

# SAML
# Ansible Local path where your saml certs/metadata are stored
saml_local_path: "{{ cycloid_local_datas_path }}/saml"

# Path where saml certs will be stored on the host
saml_config_path: "{{ cycloid_install_path }}/saml"

# SAML2 api internal path. It shouldn't be changed. Following path will be used when SAML enabled with saml_auth_enabled: true.
saml_sp_certificate_path: "{%- if saml_auth_enabled|bool -%}/secrets/saml/{{ saml_sp_certificate_file }}{%- endif -%}"
saml_sp_private_key_path: "{%- if saml_auth_enabled|bool -%}/secrets/saml/{{ saml_sp_private_key_file }}{%- endif -%}"
saml_idp_metadata_path: "{%- if saml_auth_enabled|bool and saml_idp_metadata_url == '' -%}/secrets/saml/{{ saml_idp_metadata_file }}{%- endif -%}"

###########################
# Cost Explorer / Cloud Cost Management feature (api params)
###########################
#cost_explorer_es_ca_cert: "" # PEM-formatted CA certificate of Elasticsearch

# Cloud Cost Management cmd
cycloid_job_ccm_ingestion_container_args: "/entrypoint /go/youdeploy-http-api ingest-cost-explorer --config-file=/opt/config.yml"
cycloid_job_ccm_ingestion_container_cmd: '{% if ca_certificates_container_shared|bool %}-c "apk add --update --upgrade --no-cache ca-certificates && /usr/sbin/update-ca-certificates && /entrypoint {{ cycloid_job_ccm_ingestion_container_args }}"{% else %}{{ cycloid_job_ccm_ingestion_container_args }}{% endif %}'

###########################
# Cost Estimation         #
###########################
# enable injestion if one cloud provider enabled
cycloid_job_cost_estimation_injection: "{% if cycloid_job_cost_estimation_injection_aws|bool or cycloid_job_cost_estimation_injection_azure or cycloid_job_cost_estimation_injection_gcp|bool %}true{% else %}false{% endif %}"

# command used to create an ingest job on the queue
cost_estimation_ingestion_aws_minimal: "/entrypoint /go/youdeploy-http-api pricing ingest --config-file=/opt/config.yml --pricing-ingest-providers aws --pricing-ingest-aws-use-known-services --pricing-ingest-aws-minimal; "
cost_estimation_ingestion_azure_minimal: "/entrypoint /go/youdeploy-http-api pricing ingest --config-file=/opt/config.yml --pricing-ingest-providers azure --pricing-ingest-azure-use-known-services --pricing-ingest-azure-minimal; "
cost_estimation_ingestion_gcp_minimal: "/entrypoint /go/youdeploy-http-api pricing ingest --config-file=/opt/config.yml --pricing-ingest-providers google --pricing-ingest-google-project={{ cost_estimation_gcp_project }} --pricing-ingest-google-credential-json  $PRICING_INGEST_GOOGLE_CREDENTIAL_JSON --pricing-ingest-google-use-known-services --pricing-ingest-google-minimal; "

# merge cost_estimation_ingestion cmd
cycloid_job_cost_estimation_ingestion_container_args: "{% if cycloid_job_cost_estimation_injection_aws|bool %}{{ cost_estimation_ingestion_aws_minimal }}{% endif %}{% if cycloid_job_cost_estimation_injection_azure|bool %}{{ cost_estimation_ingestion_azure_minimal }}{% endif %}{% if cycloid_job_cost_estimation_injection_gcp|bool %}{{ cost_estimation_ingestion_gcp_minimal }}{% endif %}"
cycloid_job_cost_estimation_ingestion_container_cmd: '-c {% if ca_certificates_container_shared|bool %}"apk add --update --upgrade --no-cache ca-certificates && /usr/sbin/update-ca-certificates && {{ cycloid_job_cost_estimation_ingestion_container_args }}"{% else %}"{{ cycloid_job_cost_estimation_ingestion_container_args }}"{% endif %}'

# Share host saml file with container. It shouldn't be changed.
container_volumes_saml: "{%- if saml_auth_enabled -%}{{ saml_config_path }}:/secrets/saml{%- endif -%}"

###########################
# KPI Import              #
###########################

# Cloud Cost Management cmd
cycloid_job_kpi_import_container_args: "/entrypoint /go/youdeploy-http-api kpi-import --config-file=/opt/config.yml"
cycloid_job_kpi_import_container_cmd: '{% if ca_certificates_container_shared|bool %}-c "apk add --update --upgrade --no-cache ca-certificates && /usr/sbin/update-ca-certificates && /entrypoint {{ cycloid_job_kpi_import_container_args }}"{% else %}{{ cycloid_job_kpi_import_container_args }}{% endif %}'

#
# Monitoring
#
worker_metrics_enabled: false

###########################
# report.yml playbook     #
###########################

cycloid_report_path: "/tmp/cycloid-report"
cycloid_report_local_path: "/tmp/cycloid-report-local"
cycloid_report_sensitive: false
cycloid_report_curl_timeout: 4
